---
title: "Mapping Crime Incidents in the City of Los Angeles, California"
author: "Shivani Sickotra"
date: "December 2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r echo=TRUE}
# Load the required packages
library(sf) #for spatial data
library(ggplot2) #for plotting
library(dplyr) #for data manipulation
library(RColorBrewer) #for diverging colour scheme
library(tidyverse) #for piping
library(ggmap) #for creating maps
library(png) #for importing inset map image
library(magick) #for adding inset image
library(ggpubr) #for multi-plot figures
library(cowplot) # for multi-plot figures
```

## 1) Import LA Boundary and Crime Data
```{r}
# Import the LA Shapefile using st_read 
LA <- st_read("Geo_Vis_2_Data/LA_County_City_Boundaries/LA_County_City_Boundaries.shp",
              stringsAsFactors = FALSE)

# Check CRS of the LA shapefile
#st_crs(LA)  # CRS is WGS 84, EPSG 4326

# View attribute table of the LA shapefile
#View(LA) 
```

```{r}
# Import the LA Crime Data
# https://data.lacity.org/Public-Safety/Crime-Data-from-2020-to-Present/2nrs-mtv8
# Feb 2020 to present (15/12/21)
LAcrime <- read.csv("Geo_Vis_2_Data/LA_Crime_Data_from_2020_to_Present.csv")

# View the imported dataframe
# Each observation/row is a crime incident that has occurred
#View(LAcrime)
#str(LAcrime) # see datatypes of each column 
```

## 2 Pre-process the Data

### 2.1 LA Crime Data
```{r}
# Deal with missing coord data in the LAcrime dataframe
# Select the observations where LON does NOT have 0 values OR LAT does NOT have 0 values
LAcrime <- LAcrime %>% filter(LON != 0 | LAT != 0)   # remaining 387,999 obs
```

## 2.2 City of LA Boundary Data
```{r}
# Extract only the City of LA boundary from the LA county
# Use filter from dplyr to select only the City of Los Angeles area
LA_city <- filter(LA, CITY_LABEL == "Los Angeles")

# View the geometry type of the shapefile
#st_geometry_type(LA_city)
```
```{r}

```


```{r}
# get bounding box coords of LA 
LA_city.bbox<-st_bbox(LA_city)
```
```{r}
# Plot the City of Los Angeles geometry using ggplot
ggplot() +
  geom_sf(data=LA_city) +
  # Add the crime point data +
  #geom_point(data=LAcrime, mapping = aes(x=LON, y=LAT), color="red") +
  geom_hex(data=LAcrime,
           mapping = aes(x=LON, y=LAT), bins=15, color="black")+
  #scale_fill_continuous(type = "viridis")
  scale_fill_fermenter(n.breaks=10,palette = "RdYlBu")

```
```{r}
# Plot the City of Los Angeles geometry using ggplot
ggplot() +
  #geom_sf(data=LA_city) +
  # Add the crime point data +
  #geom_point(data=LAcrime, mapping = aes(x=LON, y=LAT), color="red") +
  geom_bin_2d(data=LAcrime,
           mapping = aes(x=LON, y=LAT));

```
```{r}
# Plot the City of Los Angeles geometry using ggplot
ggplot(data=LAcrime, aes(x=LON, y=LAT)) +
  #geom_sf(data=LA_city) +
  # Add the crime point data +
  #geom_point(data=LAcrime, mapping = aes(x=LON, y=LAT), color="red") +
  geom_density_2d_filled()

```
```{r}
# Plot the City of Los Angeles geometry using ggplot
ggplot() +
  geom_sf(data=LA_city) +
  # Add the crime point data +
  #geom_point(data=LAcrime, mapping = aes(x=LON, y=LAT), color="red") +
  geom_density_2d(data=LAcrime,
           mapping = aes(x=LON, y=LAT));
  
```

```{r}
# Plot the City of Los Angeles geometry using ggplot
ggplot() +
  geom_sf(data=LA_city) +
  # Add the crime point data +
  #geom_point(data=LAcrime, mapping = aes(x=LON, y=LAT), color="red") +

  stat_density_2d(data=LAcrime, geom = "polygon", contour = TRUE,
                    aes(x=LON, y=LAT, fill = after_stat(level)), colour = "black",
                    bins = 10) +
  scale_fill_distiller(palette = "RdYlBu", direction = -1) +
  theme_classic();
```



## TYPE of crime 
```{r}
# Understand the crime categories for the incidents
# Find all unique values for the Crm.Cd.Desc variable
unique(LAcrime[c("Crm.Cd.Desc")])   # 135 different categories of crime
```
```{r}
# Get count of each type of crime 
LAcrime %>% count(Crm.Cd.Desc, sort = TRUE)

#SHOPLIFTING - PETTY THEFT ($950 & UNDER) = 6197 counts
# SHOPLIFTING-GRAND THEFT ($950.01 & OVER) = 1093 counts
# Total Shoplifting  = 7290
count(filter(LAcrime, Crm.Cd.Desc == "SHOPLIFTING - PETTY THEFT ($950 & UNDER)"))  #Petty theft/shoplifting = 1093
```


```{r include=FALSE}
# Get Basemap from online and use LA_City bounding box to contrain this
LA_bmap <- get_map(location = c(left = LA_city.bbox[[1]],
                                bottom =LA_city.bbox[[2]],
                                right = LA_city.bbox[[3]],
                                top = LA_city.bbox[[4]]),
                   source="osm")
```



```{r}
# ONLY MAPPING SHOPLIFTING GRAND AND PETTY
map2<- ggmap(LA_bmap) +   #use the LA OSM basemap
       
  # 2d kernel density estimation and display result with contours - to prevent overplotting of points
       stat_density_2d(data= filter(LAcrime, Crm.Cd.Desc == "SHOPLIFTING-GRAND THEFT ($950.01 & OVER)" | Crm.Cd.Desc =="SHOPLIFTING - PETTY THEFT ($950 & UNDER)"),
                       geom = "polygon",
                       contour = TRUE,
                       aes(x=LON, y=LAT,
                           fill = after_stat(level)),
                       alpha = 0.4,
                       colour = "darkblue",
                       bins= 6) +
       scale_fill_distiller(palette = "RdYlBu", direction = -1,
                            breaks = c(10, 15, 20, 25, 30),
                            labels = c("Low","","Med","","High"),
                            name = "Density") +
      #no axis 
       theme_void() +
       ggtitle("Shoplifting Incidents (n = 7290)") +
       theme(legend.position = "none",
             #legend.title = element_text(size=10, face="bold"),
             #legend.key.size = unit(0.5, "cm"),
             plot.title = element_text(size=9, face="bold",hjust = 0.5, vjust= 1.5),
              plot.margin = rep(unit(0,"null"),4),
              panel.margin = unit(0,"null"))
        
      
     
      

map2
```
# ALL crimes map
```{r}
# Plot the City of Los Angeles geometry using ggplot
map1<- ggplot() +
  geom_sf(data=LA_city) +
  
  stat_density_2d(data=LAcrime, geom = "polygon", contour = TRUE,
                    aes(x=LON, y=LAT, fill = after_stat(level)),
                  alpha = 0.6,
                  colour = "darkblue",
                  
                    bins = 5) +
  scale_fill_distiller(palette = "RdYlBu", direction = -1,
                       breaks = c(20, 30, 40, 50, 60),
                            labels = c("Low","","Med","","High"),
                            name = "Density") +
  theme_void() +
  ggtitle("All Crime Incidents (n = 387,999)")+
  theme(legend.position = c(0.10, 0.25),
             legend.title = element_text(size=8),
             legend.key.size = unit(0.3, "cm"),
             plot.title = element_text(size=9, face="bold",hjust = 0.5, vjust= 1.5),
         plot.margin = rep(unit(0,"null"),4),
        panel.spacing = unit(0,"null"))
```

# Inset map
```{r}
# https://nsholmes21.medium.com/the-puzzle-of-places-in-la-18e8a537e3ac
#inset <- readPNG("Geo_Vis_2_Data/LA_inset_map.png")
#inset

inset <- image_read("LA_inset_map.png")
# Resize
inset<-image_scale(inset, "122x100") # width: 300px
```
# Arrange on one page
```{r}
Map3<-ggarrange(
  ggarrange(NULL, map1, nrow = 2, heights=c(0.5,1)),
  map2,
  ncol= 3)

#annotate_figure(Map3,
#                top = text_grob("Crime Incidents and Shoplifting Density \nin the City of Los Angeles, California 2020/21", hjust=0.8,face = "bold", size = 14),
#                bottom = text_grob("Crime Data from data.lacity.org and Boundary Data from geohub.lacity.org. Created by Shivani Sickotra, December 2021", hjust=0.8, face = "italic",
#                                   size = 6))

```
```{r}
# Save map as .png with 300dpi resolution 
png("Crime_Shoplifting_LA.png", units="in", width=10, height=5.5, res=300)

Map4<-ggdraw(Map3) + 
  draw_image("LA_inset_map.png", scale=0.25, hjust=0.35, vjust=-0.3)

annotate_figure(Map4,
                top = text_grob("Crime Incidents and Shoplifting Density \nin the City of Los Angeles, California 2020/21", hjust=0.75,face = "bold", size = 14),
                left = text_grob("City of LA, LA County, CA", size = 6, face="italic", vjust=-13, hjust=-2.4),
                bottom = text_grob("Crime Data from data.lacity.org and Boundary Data from geohub.lacity.org. Created by Shivani Sickotra, December 2021", hjust=0.75, face = "italic",
                                   size = 6))

dev.off()
```

## R markdown insert the image made



